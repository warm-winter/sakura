`x86` 特权级( privilege levels )

`x86` 内存管理单元( Memory Management Unit，`MMU`)

## 7.1 了解`x86`保护模式中的特权级

### 特权级

![image-20200813041414767](.\7\image-20200813041414767.png)

一些指令（比如特权指令）只能执行在ring 0
CPU在如下时刻会检查特权级

* 访问数据段
* 访问页
* 进入中断服务例程( `ISRs `)
* ...

如果检查失败会如何?

General Protection Fault!

#### 当前的特权级

`RPL	`		    段寄存器			`DS，ES，FS, GS`
`CPL`			段寄存器			CS，SS（寄存器的后两位，同）
`DPL`			段描述符，门描述符（代表访问的目标的特权级）

#### 合法的特权级检查

（1）访问门时			`CPL <= DPL[门] &CPL >= DPL[段]`

针对中断、陷入、异常，称之为门情况。第一个，意味着这个门的特权级比较低，而我当前执行的代码段比较高，这样才允许通过门。第二个，CPL要大于等于`DPL`，通过门之后的目的是要我们去访问特权级更高的段。

实现一般特权级（ring 3）的应用程序可以访问处于内核态（ring 0）的操作系统提供的服务

（2）访问段时			`MAX(CPL, RPL) <= DPL[段]`

当前发出请求，处于代码段执行这条指令，我当前处于这个状态，我要去访问某一个数据段，我本身的特权级要高于对于那个的目标

## 7.2 了解特权级切换过程

通过**中断**切换特权级

### 中断

中断有一个中断门，有了中断门，通过中断描述符表建立好中断门来实现跳转

### 从ring 0 到 ring 3

![image-20200813043916592](.\7\image-20200813043916592.png)

通过**构造**一个能够返回到ring 3的一个**栈**（内核的一个模拟的中断栈），来完成一个执行过程，最后通过一个**`iret`指令**完成数据的更新，存储器的更新，从而实现特权级的一个转换。

### 从ring 3 到 ring 0

通过一个软中断（or trap）来完成

![image-20200813044724629](.\7\image-20200813044724629.png)

### 任务状态段（Task State Segment）`TSS`格式

这个段保存了不同特权级他所用到的寄存器里面的信息（如SS、ESP）

关注不同特权级里面的堆栈信息

![image-20200813045027252](.\7\image-20200813045027252.png)

（`TSS`里面ring 0到ring 2的堆栈信息）

全局描述符表里面保存了`TSS`一个描述符，里面保存了`TSS`的起始地址

有一个Task Register会缓存上面`TSS`这个里面的内容，所以可以根据寄存器的内容直接找到对应的位置（不用先找全局描述符表，再找到`TSS`）

![image-20200813045443494](.\7\image-20200813045443494.png)

（`ucore`里面的实现）

## 7.3 了解段/页表

`GDT`全局描述符表时放在内存里面的，因为它占的空间比较大，将隐藏的部分放在CPU里面，加快访问

![image-20200813051458842](.\7\image-20200813051458842.png)

（建立`GDT`）

虚地址比物理地址大`0xc0000000`

## 7.4 了解`ucore`建立段/页表

![image-20200813052331971](.\7\image-20200813052331971.png)

（页目录表、页表、对应的页）

在页表项中存放的地址是线性地址

`CR3`寄存器保存了页目录的表的起始地址

为了在保护模式下使能页机制，OS需要置`CR0`寄存器中的`bit 31`（PG），如果置1的话代表启动了页机制

## 7.5 演示lab 2实验环节

使用命令`find . -name "*.[chS]" -exec grep -Hn LAB2 {} \;`查找所有需要编程的地方

![image-20200813100817754](.\7\image-20200813100817754.png)

```
./kern/mm/pmm.c:329:    /* LAB2 EXERCISE 2: YOUR CODE
./kern/mm/pmm.c:382:    /* LAB2 EXERCISE 3: YOUR CODE
./kern/mm/default_pmm.c:15:// LAB2 EXERCISE 1: YOUR CODE
./kern/mm/default_pmm.c:237:// LAB2: below code is used to check the first fit allocation algorithm (your EXERCISE 1) 
```

